---
phase: "06"
plan: "06-02"
title: "GeneTable + EnrichmentTable migration"
wave: 2
depends_on: ["06-01"]
files_modified:
  - "frontend/src/components/GeneTable.vue"
  - "frontend/src/components/network/EnrichmentTable.vue"
autonomous: true
estimated_minutes: 90
requirements:
  - "TABLE-07: GeneTable uses TanStack Table with server-side pagination"
  - "TABLE-08: All 6 GeneTable filter dimensions work"
  - "TABLE-09: URL query parameter sync preserved"
  - "TABLE-10: EnrichmentTable uses TanStack Table with client-side pagination"
  - "TABLE-11: CSV export works for EnrichmentTable"

must_haves:
  truths:
    - "GeneTable.vue has zero Vuetify component tags"
    - "EnrichmentTable.vue has zero Vuetify component tags"
    - "`npm run build` succeeds"
    - "`npm run lint` has 0 errors"
    - "Gene browser loads data with server-side pagination"
    - "All 6 filter dimensions work (search, sources, tiers, score range, count range, zero-score toggle)"
    - "Sorting works (score desc, score asc, symbol A-Z, symbol Z-A)"
    - "URL parameters sync correctly (bookmarkable state)"
    - "Enrichment table renders with dynamic columns"
    - "CSV export produces valid file"
  artifacts:
    - path: "frontend/src/components/GeneTable.vue"
      provides: "TanStack Table with server-side pagination, filtering, and URL sync"
    - path: "frontend/src/components/network/EnrichmentTable.vue"
      provides: "TanStack Table with client-side pagination and CSV export"

---

# 06-02: GeneTable and EnrichmentTable Migration

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Migrate the main GeneTable (892 lines, server-side) and EnrichmentTable (442 lines, client-side) from Vuetify data tables to TanStack Table + DataTable infrastructure.

**Architecture:** Both tables use `useVueTable` from @tanstack/vue-table with the DataTable infrastructure from 06-01. GeneTable uses `manualPagination: true` + `manualSorting: true` for server-side operation. EnrichmentTable uses default client-side pagination.

---

<task id="1">
### Task 1: Migrate GeneTable — column definitions + basic table

**Files:** Modify `frontend/src/components/GeneTable.vue`

**Step 1: Define column definitions**

Replace `v-data-table-server` headers array with TanStack ColumnDef array:

```typescript
import type { ColumnDef } from '@tanstack/vue-table'
import { h } from 'vue'

interface GeneRow {
  gene_symbol: string
  hgnc_id: string
  evidence_tier: string
  evidence_count: number
  evidence_score: number
  sources: string[]
}

const columns: ColumnDef<GeneRow>[] = [
  {
    accessorKey: 'gene_symbol',
    header: ({ column }) => h(DataTableColumnHeader, { column, title: 'Gene' }),
    cell: ({ row }) => h('div', { class: 'font-medium' }, [
      h(RouterLink, {
        to: `/genes/${row.getValue('gene_symbol')}`,
        class: 'text-primary hover:underline font-mono',
      }, () => row.getValue('gene_symbol')),
    ]),
    size: 120,
  },
  {
    accessorKey: 'hgnc_id',
    header: ({ column }) => h(DataTableColumnHeader, { column, title: 'HGNC ID' }),
    cell: ({ row }) => h('span', { class: 'text-xs font-mono text-muted-foreground' }, row.getValue('hgnc_id')),
    size: 100,
  },
  {
    accessorKey: 'evidence_tier',
    header: 'Tier',
    cell: ({ row }) => h(EvidenceTierBadge, { tier: row.getValue('evidence_tier'), size: 'small' }),
    size: 100,
  },
  {
    accessorKey: 'evidence_count',
    header: ({ column }) => h(DataTableColumnHeader, { column, title: 'Evidence' }),
    cell: ({ row }) => {
      const count = row.getValue('evidence_count') as number
      return h(Badge, {
        variant: 'secondary',
        class: 'font-mono',
      }, () => count)
    },
    size: 80,
  },
  {
    accessorKey: 'evidence_score',
    header: ({ column }) => h(DataTableColumnHeader, { column, title: 'Score' }),
    cell: ({ row }) => h(ScoreBreakdown, {
      score: row.getValue('evidence_score'),
      breakdown: row.original.score_breakdown,
      variant: 'inline',
      size: 'small',
    }),
    size: 100,
  },
  {
    accessorKey: 'sources',
    header: 'Sources',
    cell: ({ row }) => {
      const sources = row.getValue('sources') as string[]
      return h('div', { class: 'flex flex-wrap gap-1' },
        sources.slice(0, 3).map(s =>
          h(Badge, { variant: 'outline', class: 'text-[10px]', key: s }, () => s)
        ).concat(
          sources.length > 3
            ? [h('span', { class: 'text-xs text-muted-foreground' }, `+${sources.length - 3}`)]
            : []
        )
      )
    },
    enableSorting: false,
    size: 180,
  },
]
```

**Step 2: Set up useVueTable with server-side**

```typescript
import { useVueTable, getCoreRowModel, getSortedRowModel } from '@tanstack/vue-table'

const table = useVueTable({
  get data() { return genes.value },
  columns,
  getCoreRowModel: getCoreRowModel(),
  manualPagination: true,
  manualSorting: true,
  get pageCount() { return Math.ceil(totalGenes.value / pageSize.value) },
  state: {
    get pagination() {
      return { pageIndex: currentPage.value - 1, pageSize: pageSize.value }
    },
    get sorting() {
      return sortState.value
    },
  },
  onPaginationChange: (updater) => {
    const newState = typeof updater === 'function'
      ? updater({ pageIndex: currentPage.value - 1, pageSize: pageSize.value })
      : updater
    currentPage.value = newState.pageIndex + 1
    pageSize.value = newState.pageSize
    fetchGenes()
  },
  onSortingChange: (updater) => {
    const newState = typeof updater === 'function' ? updater(sortState.value) : updater
    sortState.value = newState
    fetchGenes()
  },
})
```

**Step 3: Replace template**

Replace `v-data-table-server` with DataTable:
```vue
<DataTable :table="table" />
<DataTablePagination :table="table" :page-size-options="[10, 20, 50, 100]" />
```

**Commit:**
```bash
git add frontend/src/components/GeneTable.vue
git commit -m "feat(06-02): migrate GeneTable to TanStack Table with column definitions"
```
</task>

<task id="2" depends_on="1">
### Task 2: GeneTable — filters

**Files:** Modify `frontend/src/components/GeneTable.vue`

Replace the filter controls:

**Search input:**
```vue
<!-- v-text-field → Input -->
<div class="relative">
  <Search :size="16" class="absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground" />
  <Input
    v-model="search"
    placeholder="Search genes..."
    class="pl-9"
    @input="debouncedSearch"
  />
</div>
```

**Source filter (multi-select using Popover + Command):**
```vue
<DataTableFacetedFilter
  :column="table.getColumn('sources')"
  title="Sources"
  :options="sourceOptions"
/>
```

Or use custom Popover-based multi-select (same pattern as Dashboard tier filter):
```vue
<Popover>
  <PopoverTrigger as-child>
    <Button variant="outline" size="sm" class="h-9">
      Sources
      <Badge v-if="selectedSources.length" variant="secondary" class="ml-2">
        {{ selectedSources.length }}
      </Badge>
    </Button>
  </PopoverTrigger>
  <PopoverContent class="w-[200px] p-0">
    <!-- Source checkboxes -->
  </PopoverContent>
</Popover>
```

**Score range slider:**
```vue
<!-- v-range-slider → Slider (dual thumb) -->
<div class="space-y-2">
  <Label class="text-xs">Evidence Score</Label>
  <Slider
    v-model="evidenceScoreRange"
    :min="0"
    :max="100"
    :step="1"
    class="w-full"
  />
  <div class="flex justify-between text-xs text-muted-foreground">
    <span>{{ evidenceScoreRange[0] }}</span>
    <span>{{ evidenceScoreRange[1] }}</span>
  </div>
</div>
```

**Note:** shadcn-vue Slider supports range (dual thumb) via array model value.

**Evidence count range:** Same Slider pattern.

**Show zero-score toggle:**
```vue
<div class="flex items-center gap-2">
  <Switch v-model:checked="showZeroScoreGenes" />
  <Label class="text-xs">Show zero-score genes</Label>
</div>
```

**Sort dropdown:**
```vue
<Select v-model="sortOption">
  <SelectTrigger class="w-[180px]">
    <SelectValue placeholder="Sort by..." />
  </SelectTrigger>
  <SelectContent>
    <SelectItem value="score_desc">Score (High → Low)</SelectItem>
    <SelectItem value="score_asc">Score (Low → High)</SelectItem>
    <SelectItem value="symbol_asc">Symbol (A → Z)</SelectItem>
    <SelectItem value="symbol_desc">Symbol (Z → A)</SelectItem>
  </SelectContent>
</Select>
```

**Wrap everything in a Card:**
```vue
<Card>
  <CardContent class="pt-6">
    <div class="flex flex-col gap-4">
      <!-- Row 1: Search + Sort -->
      <div class="flex flex-col sm:flex-row gap-4">
        <!-- search input -->
        <!-- sort select -->
      </div>
      <!-- Row 2: Filters -->
      <div class="flex flex-wrap gap-4">
        <!-- source filter, tier filter, score slider, count slider, zero-score switch -->
      </div>
    </div>
  </CardContent>
</Card>
```

**Preserve URL query parameter sync** — keep `parseUrlParams()` and `updateUrl()` functions. Map new state to URL params.

**Commit:**
```bash
git add frontend/src/components/GeneTable.vue
git commit -m "feat(06-02): migrate GeneTable filters to Input + Select + Slider + Switch"
```
</task>

<task id="3" depends_on="2">
### Task 3: Migrate EnrichmentTable.vue

**Files:** Modify `frontend/src/components/network/EnrichmentTable.vue`

**Key changes:**
1. Replace `v-card` → Card
2. Replace `v-select` → Select
3. Replace `v-text-field` → Input
4. Replace `v-data-table` (client-side) → DataTable with useVueTable (no manual pagination)
5. Replace `v-chip` → Badge
6. Replace `v-dialog` (gene list) → Dialog
7. Replace `v-progress-circular` → Tailwind spinner
8. Replace `v-alert` → Alert
9. Replace manual pagination → DataTablePagination

**TanStack Table setup (client-side):**
```typescript
const table = useVueTable({
  get data() { return filteredResults.value },
  columns: enrichmentColumns,
  getCoreRowModel: getCoreRowModel(),
  getPaginationRowModel: getPaginationRowModel(),
  getSortedRowModel: getSortedRowModel(),
})
```

**Dynamic columns** (enrichment type changes columns):
```typescript
const enrichmentColumns = computed<ColumnDef<any>[]>(() => [
  {
    accessorKey: 'term',
    header: ({ column }) => h(DataTableColumnHeader, { column, title: 'Term' }),
    cell: ({ row }) => h('span', { class: 'text-sm max-w-[300px] truncate block' }, row.getValue('term')),
  },
  {
    accessorKey: 'fdr',
    header: ({ column }) => h(DataTableColumnHeader, { column, title: 'FDR' }),
    cell: ({ row }) => {
      const fdr = row.getValue('fdr') as number
      return h(Badge, {
        variant: 'outline',
        style: { backgroundColor: getFdrColor(fdr) + '20', color: getFdrColor(fdr) },
      }, () => formatPValue(fdr))
    },
  },
  // ... more columns based on enrichment type
])
```

**Preserve:** CSV export function, FDR color coding, gene list dialog.

**Gene list dialog:**
```vue
<Dialog v-model:open="showGeneDialog">
  <DialogContent class="max-w-md">
    <DialogHeader>
      <DialogTitle>Genes in term</DialogTitle>
    </DialogHeader>
    <ScrollArea class="max-h-[300px]">
      <div class="flex flex-wrap gap-1">
        <Badge
          v-for="gene in selectedGenes"
          :key="gene"
          variant="outline"
          class="cursor-pointer hover:bg-primary/10"
          @click="emit('geneClick', gene)"
        >
          {{ gene }}
        </Badge>
      </div>
    </ScrollArea>
  </DialogContent>
</Dialog>
```

**Commit:**
```bash
git add frontend/src/components/network/EnrichmentTable.vue
git commit -m "feat(06-02): migrate EnrichmentTable to TanStack Table + Card"
```
</task>

<task id="4" depends_on="1,2,3">
### Task 4: Phase 06 Verification

**Build + lint:**
```bash
cd frontend && npm run build && npm run lint
```

**Vuetify audit:**
```bash
grep -E "v-data-table|v-pagination|v-text-field|v-select|v-range-slider|v-switch|v-card|v-chip|v-tooltip|v-menu|v-progress-linear|v-dialog|v-alert|v-btn|v-progress-circular|v-divider" \
  frontend/src/components/GeneTable.vue \
  frontend/src/components/network/EnrichmentTable.vue
```
Expected: 0 matches.

**Functional verification:**
- `/genes` — Gene table loads with server-side data
- Pagination: click page 2, page 3 — data changes
- Sorting: change to Score (Low → High) — order changes
- Search: type gene name — results filter
- Source filter: select PanelApp — only PanelApp genes shown
- Score range slider: drag to 50-100 — filters applied
- URL params: change filters → URL updates, reload page → filters restore
- Network analysis → enrichment table renders with FDR badges
- CSV export downloads valid file
</task>
