---
phase: 02-typescript-migration
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - frontend/src/api/client.ts
  - frontend/src/api/auth.ts
  - frontend/src/api/genes.ts
  - frontend/src/api/statistics.ts
  - frontend/src/api/network.ts
  - frontend/src/api/datasources.ts
  - frontend/src/api/admin/annotations.ts
  - frontend/src/api/admin/cache.ts
  - frontend/src/api/admin/ingestion.ts
  - frontend/src/api/admin/logs.ts
  - frontend/src/api/admin/pipeline.ts
  - frontend/src/api/admin/staging.ts
  - frontend/src/services/logService.ts
  - frontend/src/services/websocket.ts
  - frontend/src/api/__tests__/client.spec.ts
  - frontend/src/api/__tests__/genes.spec.ts
  - frontend/src/api/__tests__/statistics.spec.ts
  - frontend/src/api/__tests__/auth.spec.ts
autonomous: true

must_haves:
  truths:
    - "All 12 API modules return typed response interfaces — callers receive autocompletion for response fields"
    - "Axios client has typed interceptors with _retry augmentation — no any casts"
    - "LogService class is typed and exports the class type for Window augmentation refinement"
    - "WebSocket service has typed message handlers and connection state"
    - "API module tests mock Axios client and verify request construction"
  artifacts:
    - path: "frontend/src/api/client.ts"
      provides: "Typed Axios instance with request/response interceptors"
      exports: ["default (apiClient)"]
      contains: "declare module 'axios'"
    - path: "frontend/src/api/genes.ts"
      provides: "Typed gene API with GeneListResult interface"
      exports: ["getGenes", "getGene", "getGeneEvidence", "getGeneAnnotations"]
    - path: "frontend/src/services/logService.ts"
      provides: "LogService class with typed public API"
      exports: ["LogService", "logService", "LogLevel"]
    - path: "frontend/src/services/websocket.ts"
      provides: "Typed WebSocket service with message handler types"
      exports: ["WebSocketService"]
    - path: "frontend/src/api/__tests__/client.spec.ts"
      provides: "Tests for Axios client interceptor behavior"
      min_lines: 20
  key_links:
    - from: "frontend/src/api/client.ts"
      to: "frontend/env.d.ts"
      via: "window._env_ access uses typed Window interface"
      pattern: "window\\._env_"
    - from: "frontend/src/api/genes.ts"
      to: "frontend/src/types/gene.ts"
      via: "imports Gene, GeneListParams types"
      pattern: "import type.*Gene"
    - from: "frontend/src/services/logService.ts"
      to: "frontend/src/types/log.ts"
      via: "imports LogEntry, LogLevel types"
      pattern: "import type.*LogEntry"
    - from: "frontend/src/api/admin/*.ts"
      to: "frontend/src/api/client.ts"
      via: "imports apiClient for HTTP requests"
      pattern: "import apiClient from"
---

<objective>
Migrate the API client, all 12 API modules, and both services (logService, websocket) to TypeScript with fully typed request/response interfaces. Write API module tests per TEST-05 requirement.

Purpose: The API layer is consumed by every store, composable, and component. Typed API modules ensure that all downstream consumers (migrated in Plan 03) receive autocompletion and type-safe data access, catching integration errors at compile time rather than runtime.

Output: 14 renamed .ts files (API client + 12 API modules + 2 services) + 4 test files verifying request construction.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-typescript-migration/02-RESEARCH.md
@.planning/phases/02-typescript-migration/02-CONTEXT.md
@.planning/phases/02-typescript-migration/02-01-SUMMARY.md

Key references from 02-RESEARCH.md:
- API Module Return Type Catalog (section) — documents which modules return response.data vs raw AxiosResponse
- Critical Typing Problem #3: Axios _retry augmentation needed in client.ts
- Critical Typing Problem #6: window.logService.warning() bug (already fixed in Plan 01 for networkStateCodec)
- Pitfall #4: Admin API modules return Promise<AxiosResponse<T>> not Promise<T>
- Test pattern: vi.mock('@/api/client') with get/post/put/delete mocks

Key API return patterns:
- Public modules (genes, statistics, network, auth, datasources): extract response.data, return typed objects
- Admin modules (annotations, cache, ingestion, logs, pipeline, staging): return raw AxiosResponse (callers use .data)
- Exception: admin/logs.exportLogs returns response.data directly
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate API client, logService, and all 12 API modules to TypeScript</name>
  <files>
    frontend/src/api/client.ts
    frontend/src/api/auth.ts
    frontend/src/api/genes.ts
    frontend/src/api/statistics.ts
    frontend/src/api/network.ts
    frontend/src/api/datasources.ts
    frontend/src/api/admin/annotations.ts
    frontend/src/api/admin/cache.ts
    frontend/src/api/admin/ingestion.ts
    frontend/src/api/admin/logs.ts
    frontend/src/api/admin/pipeline.ts
    frontend/src/api/admin/staging.ts
    frontend/src/services/logService.ts
  </files>
  <action>
  Use `git mv` for each .js -> .ts rename to preserve history. Add full type annotations.

  **Migration order** (dependency-safe):

  **Step 1: `src/api/client.js` -> `client.ts`**
  - Add Axios module augmentation for `_retry`:
    ```typescript
    import 'axios'
    declare module 'axios' {
      interface InternalAxiosRequestConfig {
        _retry?: boolean
      }
    }
    ```
  - Type the `apiClient` as `AxiosInstance`
  - Type interceptor callbacks: request interceptor receives `InternalAxiosRequestConfig`, response error interceptor receives `AxiosError`
  - `window._env_` access is already typed from env.d.ts (Plan 01)
  - Keep default export of `apiClient`

  **Step 2: `src/services/logService.js` -> `logService.ts`**
  - Export the `LogService` class with typed properties:
    - `store: ReturnType<typeof useLogStore> | null`
    - `consoleEcho: boolean`
    - `maxEntries: number`
    - `minLogLevel: string` (or use the LogLevel type from types/log.ts)
    - `correlationId: string | null`
    - `metadata: Record<string, unknown>`
  - Import `LogLevel` type and `LogEntry` type from `@/types/log` using `import type`
  - Type all public methods (debug, info, warn, error, critical, etc.) with proper parameter types
  - Type `_log(level: string, message: string, data?: unknown): void`
  - Type `logPerformance(operation: string, startTime: number, data?: Record<string, unknown>): void`
  - Type `logApiCall(method: string, url: string, status: number, duration: number): void`
  - Export both the singleton instance (`logService`) and the class (`LogService`)
  - The `LogLevel` constant object must also be typed — define it using `as const` for literal types
  - **After migrating logService.ts, update env.d.ts Window.logService** to use the actual `LogService` type if a cleaner approach is possible. If the initial minimal interface from Plan 01 works fine, leave it.

  **Step 3: Public API modules (Tier 3, depend on client)**
  Each file: `git mv src/api/foo.js src/api/foo.ts`, then add types.

  - `src/api/auth.ts` — Import `LoginResponse`, `User` from `@/types/auth`. Type all functions:
    - `login(username: string, password: string): Promise<LoginResponse>`
    - `getCurrentUser(): Promise<User>`
    - `refreshToken(token: string): Promise<{ access_token: string }>`
    - `logout(): Promise<void>`
    - `requestPasswordReset(email: string): Promise<void>`
    - `resetPassword(token: string, newPassword: string): Promise<void>`
    - `changePassword(currentPassword: string, newPassword: string): Promise<void>`
    - `registerUser(userData: RegisterUserData): Promise<User>` — define `RegisterUserData` interface locally
    - `getAllUsers(): Promise<User[]>`
    - `updateUser(userId: number, updates: Partial<User>): Promise<User>`
    - `deleteUser(userId: number): Promise<void>`

  - `src/api/genes.ts` — Import `Gene`, `GeneDetail`, `GeneListParams` from `@/types/gene`. Create:
    - `GeneListResult` interface: `{ items: Gene[]; total: number; page: number; perPage: number; pageCount: number; meta: JsonApiMeta }`
    - Type all functions with explicit return types
    - Type the internal JSON:API response parsing (the `data` array extraction and attribute flattening)
    - Uses `window.logService` (typed from env.d.ts)

  - `src/api/statistics.ts` — Create typed response interfaces for each endpoint:
    - `getSourceOverlaps()`, `getSourceDistributions()`, `getEvidenceComposition()`, `getSummaryStatistics()`
    - All return `{ data: T; meta: JsonApiMeta }` pattern — type T per endpoint or use generic

  - `src/api/network.ts` — Type the 5 network API functions with typed request params and response shapes (Cytoscape JSON format)

  - `src/api/datasources.ts` — Type 2 simple functions with response types

  **Step 4: Admin API modules (Tier 3, depend on client)**
  **IMPORTANT:** Admin modules return `Promise<AxiosResponse<T>>` (raw response), NOT `Promise<T>`.
  The ONE exception is `admin/logs.exportLogs()` which returns `response.data` directly.

  For each admin module (`annotations`, `cache`, `ingestion`, `logs`, `pipeline`, `staging`):
  - `git mv` to .ts
  - Import `AxiosResponse` from `axios` using `import type`
  - Type each function as returning `Promise<AxiosResponse<ResponseType>>`
  - Define response type interfaces per function where shapes are known
  - For endpoints with unknown response shapes, use `Promise<AxiosResponse<unknown>>`

  **Step 5: `src/services/websocket.js` -> `websocket.ts`**
  - Type the WebSocket service class:
    - `socket: WebSocket | null`
    - `isConnected: Ref<boolean>` (uses Vue ref)
    - `messageHandlers: Map<string, ((data: unknown) => void)[]>`
  - Type all public methods: connect, disconnect, send, on, off
  - Import `WebSocketMessage` from `@/types/pipeline` if applicable
  - `window.logService` access is typed from env.d.ts
  </action>
  <verify>
  Run `cd frontend && npm run build` — must exit 0.
  Run `cd frontend && npx vue-tsc --noEmit --project tsconfig.app.json 2>&1 | head -30` — no errors from migrated files.
  Verify no .js files remain: `ls frontend/src/api/*.js frontend/src/api/admin/*.js frontend/src/services/*.js 2>/dev/null` should return nothing.
  Verify exports are typed: `cd frontend && npx vue-tsc --noEmit 2>&1 | grep -i "error" | wc -l` shows 0.
  </verify>
  <done>
  - api/client.ts has Axios module augmentation for _retry and typed interceptors
  - logService.ts exports LogService class type and singleton instance
  - All 12 API modules have typed return values matching their actual return patterns (public: Promise<T>, admin: Promise<AxiosResponse<T>>)
  - websocket.ts has typed message handlers and connection state
  - No .js files remain in src/api/, src/api/admin/, src/services/
  - npm run build exits 0
  </done>
</task>

<task type="auto">
  <name>Task 2: Write API module tests (TEST-05)</name>
  <files>
    frontend/src/api/__tests__/client.spec.ts
    frontend/src/api/__tests__/genes.spec.ts
    frontend/src/api/__tests__/statistics.spec.ts
    frontend/src/api/__tests__/auth.spec.ts
  </files>
  <action>
  Create API module tests that mock the Axios client and verify request construction. Follow the test pattern from 02-RESEARCH.md.

  **Test mock setup (shared across all test files):**
  ```typescript
  import { vi } from 'vitest'
  vi.mock('@/api/client', () => ({
    default: {
      get: vi.fn(),
      post: vi.fn(),
      put: vi.fn(),
      delete: vi.fn(),
      interceptors: {
        request: { use: vi.fn() },
        response: { use: vi.fn() }
      }
    }
  }))
  import apiClient from '@/api/client'
  ```

  **1. `src/api/__tests__/client.spec.ts`** (~2-3 tests):
  - Test that apiClient is an Axios instance (verify baseURL is set)
  - Test request interceptor adds Authorization header when token exists in localStorage
  - Test request interceptor does NOT add Authorization header when no token
  - Use `vi.spyOn(localStorage, 'getItem')` for token mocking

  **2. `src/api/__tests__/genes.spec.ts`** (~3 tests):
  - Test `getGenes()` calls correct endpoint `/api/genes/` with pagination params
  - Test `getGene(symbol)` calls `/api/genes/{symbol}` and extracts attributes
  - Test `getGeneEvidence(symbol)` calls correct endpoint

  **3. `src/api/__tests__/statistics.spec.ts`** (~2 tests):
  - Test `getSummaryStatistics()` calls `/api/statistics/summary`
  - Test `getSourceDistributions()` calls correct endpoint

  **4. `src/api/__tests__/auth.spec.ts`** (~3 tests):
  - Test `login()` posts to `/api/auth/login` with form data
  - Test `getCurrentUser()` calls `/api/auth/me`
  - Test `refreshToken()` posts refresh token

  **Requirements from CONTEXT.md:**
  - ~2-3 tests per module (verify URL, params, headers)
  - Mock Axios client, NOT actual HTTP requests
  - Use `vi.mocked(apiClient.get).mockResolvedValue()` for response mocking
  - Each test uses `beforeEach(() => { vi.clearAllMocks() })`
  - Test files go in `__tests__/` directories adjacent to source files

  **Claude's discretion:** Whether to add tests for admin API modules. The TEST-05 requirement says "typed API client and interceptors" — the 4 test files above cover the core. Additional admin module tests are optional.
  </action>
  <verify>
  Run `cd frontend && npx vitest run --reporter=verbose 2>&1 | tail -20` — all new tests pass.
  Run `cd frontend && npx vitest run 2>&1 | grep -E "Tests|Pass|Fail"` — shows passing test count.
  Verify test files exist: `ls frontend/src/api/__tests__/*.spec.ts`
  </verify>
  <done>
  - 4 test files created with ~10-12 tests total
  - Tests mock Axios client and verify request URL/params construction
  - All tests pass with `vitest run`
  - Tests cover: client interceptors, genes API, statistics API, auth API
  - TEST-05 requirement satisfied
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && npm run build` exits 0 — application still builds
2. `cd frontend && npx vue-tsc --noEmit` — zero type errors from migrated files
3. `cd frontend && npx vitest run` — all tests pass (existing Button test + new API tests)
4. `ls frontend/src/api/*.js frontend/src/api/admin/*.js frontend/src/services/*.js 2>/dev/null` returns empty
5. `cd frontend && npm run dev` — application loads and functions (no visual changes)
</verification>

<success_criteria>
- All 12 API modules have typed response interfaces with autocompletion support
- Axios client has _retry module augmentation (no any casts)
- LogService exports class type + singleton instance
- WebSocket service has typed message handlers
- 10+ API module tests pass verifying request construction
- Zero regressions: npm run build exits 0, application functions identically
</success_criteria>

<output>
After completion, create `.planning/phases/02-typescript-migration/02-02-SUMMARY.md`
</output>
