---
phase: 02-typescript-migration
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - frontend/src/stores/auth.ts
  - frontend/src/stores/logStore.ts
  - frontend/src/router/index.ts
  - frontend/src/main.ts
  - frontend/src/composables/useBackupApi.ts
  - frontend/src/composables/useBackupFormatters.ts
  - frontend/src/composables/useD3Tooltip.ts
  - frontend/src/composables/useNetworkSearch.ts
  - frontend/src/composables/useNetworkUrlState.ts
  - frontend/src/composables/useSettingsApi.ts
  - frontend/src/components/branding/index.ts
  - frontend/src/components/visualizations/index.ts
  - frontend/src/stores/__tests__/auth.spec.ts
  - frontend/src/stores/__tests__/logStore.spec.ts
  - frontend/src/composables/__tests__/useBackupFormatters.spec.ts
  - frontend/src/composables/__tests__/useNetworkSearch.spec.ts
autonomous: true

must_haves:
  truths:
    - "Both Pinia stores have typed state, getters, and actions — TypeScript catches a type error if an action returns the wrong shape"
    - "All 6 composables have typed return values — Vue components using them receive typed data"
    - "Router has typed route meta (requiresAuth, requiresAdmin) via vue-router module augmentation"
    - "main.ts boots the app with typed plugin registration"
    - "vue-tsc --noEmit exits with zero errors across ALL .ts files in the project"
    - "Store and composable tests pass in CI"
  artifacts:
    - path: "frontend/src/stores/auth.ts"
      provides: "Typed auth store with User state, token management, admin actions"
      exports: ["useAuthStore"]
      contains: "ref<User | null>"
    - path: "frontend/src/stores/logStore.ts"
      provides: "Typed log store with LogEntry array state"
      exports: ["useLogStore"]
      contains: "ref<LogEntry[]>"
    - path: "frontend/src/router/index.ts"
      provides: "Typed router with RouteMeta augmentation"
      exports: ["default (router)"]
      contains: "declare module 'vue-router'"
    - path: "frontend/src/main.ts"
      provides: "Typed app entry point"
      min_lines: 30
    - path: "frontend/src/stores/__tests__/auth.spec.ts"
      provides: "Auth store state + behavior tests"
      min_lines: 50
    - path: "frontend/src/composables/__tests__/useBackupFormatters.spec.ts"
      provides: "Composable tests for pure formatting functions"
      min_lines: 20
  key_links:
    - from: "frontend/src/stores/auth.ts"
      to: "frontend/src/api/auth.ts"
      via: "imports typed auth API functions"
      pattern: "import.*from '@/api/auth'"
    - from: "frontend/src/stores/auth.ts"
      to: "frontend/src/types/auth.ts"
      via: "uses User, LoginResponse types for ref generics"
      pattern: "import type.*User"
    - from: "frontend/src/stores/logStore.ts"
      to: "frontend/src/types/log.ts"
      via: "uses LogEntry type for state array"
      pattern: "import type.*LogEntry"
    - from: "frontend/src/router/index.ts"
      to: "frontend/src/stores/auth.ts"
      via: "navigation guard checks authStore.isAuthenticated"
      pattern: "useAuthStore"
    - from: "frontend/src/main.ts"
      to: "frontend/src/services/logService.ts"
      via: "initializes logService with store, sets window.logService"
      pattern: "logService.initStore"
    - from: "frontend/src/composables/useNetworkUrlState.ts"
      to: "frontend/src/utils/debounce.ts"
      via: "uses DebouncedFunction type for syncStateToUrl"
      pattern: "import.*debounce"
---

<objective>
Migrate both Pinia stores, router, main.ts, all 6 composables, and 2 component index files to TypeScript. Write store and composable tests. Run vue-tsc --noEmit to verify zero errors across the entire project (TSML-08).

Purpose: This is the final wave of Phase 2. After this plan, every non-component .js file in the frontend is TypeScript. Stores provide typed reactive state to all Vue components. The router provides typed meta fields for navigation guards. Composables provide typed return values for component consumption. vue-tsc passing proves the entire type system is coherent.

Output: 12 renamed .ts files + 4 test files + vue-tsc clean pass confirming TSML-08.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-typescript-migration/02-RESEARCH.md
@.planning/phases/02-typescript-migration/02-CONTEXT.md
@.planning/phases/02-typescript-migration/02-01-SUMMARY.md
@.planning/phases/02-typescript-migration/02-02-SUMMARY.md

Key references from 02-RESEARCH.md:
- Pitfall #3: Pinia refs need explicit generics — `ref<User | null>(null)` not `ref(null)`
- Critical Typing Problem #4: LogStore LogEntry interface
- Critical Typing Problem #6: Router RouteMeta augmentation
- Tier 5-6 dependency order: stores -> router -> main.ts -> composables
- Test depth from CONTEXT.md: Store tests: 5-8 per store, composable tests: Claude's discretion
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate stores, router, and main.ts to TypeScript</name>
  <files>
    frontend/src/stores/auth.ts
    frontend/src/stores/logStore.ts
    frontend/src/router/index.ts
    frontend/src/main.ts
    frontend/src/components/branding/index.ts
    frontend/src/components/visualizations/index.ts
  </files>
  <action>
  Use `git mv` for each .js -> .ts rename. Add full type annotations.

  **Migration order** (dependency-safe):

  **Step 1: `src/stores/logStore.js` -> `logStore.ts`** (no store dependencies)
  - Import `LogEntry` and `LogLevel` types from `@/types/log` using `import type`
  - Type all refs with explicit generics:
    - `const logs = ref<LogEntry[]>([])`
    - Other state refs with appropriate types
  - Type the `addLogEntry(entry: LogEntry, maxEntries?: number)` function parameter
  - Type all computed getters with explicit return types
  - Type `trimLogs(maxEntries: number)` and `clearLogs()` functions
  - Export type should be inferred by Pinia's `defineStore` — no manual store type needed

  **Step 2: `src/stores/auth.js` -> `auth.ts`**
  - Import `User`, `LoginResponse` from `@/types/auth` using `import type`
  - Import auth API functions — they are now typed (from Plan 02)
  - Type all refs with explicit generics:
    - `const user = ref<User | null>(null)` — CRITICAL: must NOT be `ref(null)` (Pitfall #3)
    - `const accessToken = ref<string | null>(localStorage.getItem('access_token'))`
    - `const refreshToken = ref<string | null>(localStorage.getItem('refresh_token'))`
    - `const isLoading = ref(false)` (boolean inference is fine)
    - `const error = ref<string | null>(null)`
  - Type all action function parameters:
    - `login(username: string, password: string): Promise<boolean>`
    - `registerUser(userData: RegisterUserData): Promise<User>` — use the type from api/auth.ts
    - `updateUser(userId: number, updates: Partial<User>): Promise<User>`
    - `deleteUser(userId: number): Promise<void>`
    - `changePassword(currentPassword: string, newPassword: string): Promise<boolean>`
    - `requestPasswordReset(email: string): Promise<boolean>`
    - `resetPassword(token: string, newPassword: string): Promise<boolean>`
  - Type computed getters — `hasPermission` and `hasRole` are computed that return functions:
    - `const hasPermission = computed(() => (permission: string): boolean => { ... })`
    - `const hasRole = computed(() => (role: string | string[]): boolean => { ... })`
  - Type the `err` catch parameter — use AxiosError or typed catch: `catch (err: unknown)` then narrow with `if (err instanceof AxiosError)` or `if (err && typeof err === 'object' && 'response' in err)`
  - `window.logService` calls are typed from env.d.ts

  **Step 3: `src/router/index.js` -> `index.ts`**
  - Add Vue Router module augmentation at top of file:
    ```typescript
    import 'vue-router'
    declare module 'vue-router' {
      interface RouteMeta {
        requiresAuth?: boolean
        requiresAdmin?: boolean
      }
    }
    ```
  - Import `RouteRecordRaw` from `vue-router` using `import type`
  - Type the `routes` array as `RouteRecordRaw[]`
  - Type the navigation guard callback — `to`, `from` are `RouteLocationNormalized`, `next` is `NavigationGuardNext`
  - The `beforeEnter` guard on gene-structure route should type `to.params.symbol` as `string | string[]` and handle accordingly

  **Step 4: `src/main.js` -> `main.ts`**
  - Import types as needed using `import type`
  - `createApp(App)` return is typed as `App<Element>` by Vue
  - `createPinia()` return is typed by Pinia
  - `app.config.globalProperties.$log = logService` — may need type augmentation for `$log`:
    ```typescript
    declare module 'vue' {
      interface ComponentCustomProperties {
        $log: typeof logService
      }
    }
    ```
    Or skip this augmentation if `$log` is not used in components (components use `window.logService` instead). Check usage first — if only `window.logService` is used in components, the Vue augmentation is unnecessary.
  - `window.logService = logService` — already typed from env.d.ts

  **Step 5: Component index files (trivial)**
  - `src/components/branding/index.js` -> `index.ts` — just component re-exports, trivial
  - `src/components/visualizations/index.js` -> `index.ts` — 3 component re-exports, trivial
  - These are 1-3 line files, just rename with `git mv`
  </action>
  <verify>
  Run `cd frontend && npm run build` — must exit 0.
  Run `cd frontend && npx vue-tsc --noEmit --project tsconfig.app.json 2>&1 | head -30` — no errors from migrated files.
  Verify no .js files remain: `ls frontend/src/stores/*.js frontend/src/router/*.js frontend/src/main.js 2>/dev/null` should return nothing.
  Verify renames: `git log --follow --oneline -3 frontend/src/stores/auth.ts`
  </verify>
  <done>
  - auth.ts has fully typed state (ref<User | null>), getters, and actions
  - logStore.ts has typed LogEntry[] state and typed addLogEntry parameter
  - router/index.ts has RouteMeta augmentation for requiresAuth/requiresAdmin
  - main.ts boots app with typed plugin registration and logService initialization
  - Component index files are .ts
  - npm run build exits 0
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate composables, write store and composable tests, verify vue-tsc</name>
  <files>
    frontend/src/composables/useBackupApi.ts
    frontend/src/composables/useBackupFormatters.ts
    frontend/src/composables/useD3Tooltip.ts
    frontend/src/composables/useNetworkSearch.ts
    frontend/src/composables/useNetworkUrlState.ts
    frontend/src/composables/useSettingsApi.ts
    frontend/src/stores/__tests__/auth.spec.ts
    frontend/src/stores/__tests__/logStore.spec.ts
    frontend/src/composables/__tests__/useBackupFormatters.spec.ts
    frontend/src/composables/__tests__/useNetworkSearch.spec.ts
  </files>
  <action>
  **Part A: Migrate all 6 composables**

  Use `git mv` for each .js -> .ts rename. Add full type annotations.

  - `src/composables/useBackupFormatters.js` -> `.ts` (LOW, no deps)
    - Pure formatting functions — type params and returns
    - Return typed object with all formatter functions

  - `src/composables/useD3Tooltip.js` -> `.ts` (MEDIUM, no project deps)
    - Type D3 selection types using `d3.Selection`
    - Type `MouseEvent` parameter in event handlers
    - Type the returned `{ showTooltip, hideTooltip, cleanup }` object
    - `onUnmounted` lifecycle hook is typed by Vue

  - `src/composables/useNetworkSearch.js` -> `.ts` (LOW, depends on wildcardMatcher)
    - Import typed functions from `@/utils/wildcardMatcher` (migrated in Plan 01)
    - Type search results and return value

  - `src/composables/useBackupApi.js` -> `.ts` (MEDIUM, depends on auth store)
    - Uses `fetch()` directly (not Axios) — type fetch responses
    - Import `useAuthStore` (now typed from Task 1)
    - Type all refs and returned reactive state
    - Type backup-related interfaces (BackupInfo, BackupDetails, etc.)

  - `src/composables/useSettingsApi.js` -> `.ts` (MEDIUM, same pattern as useBackupApi)
    - Uses `fetch()` directly — type responses
    - Import `useAuthStore`
    - Type settings interfaces and returned reactive state

  - `src/composables/useNetworkUrlState.js` -> `.ts` (HIGH, most complex)
    - Import `DebouncedFunction` from `@/utils/debounce` (typed in Plan 01)
    - Import typed functions from `@/utils/networkStateCodec` (typed in Plan 01)
    - Import `useRouter`, `useRoute` from `vue-router` (typed)
    - `window.snackbar` access is typed from env.d.ts
    - Type all refs with explicit generics for complex state
    - Type the `syncStateToUrl` debounced function properly using `DebouncedFunction<T>`
    - Return typed object with all state and methods

  **Part B: Write store tests (TEST-04 partial)**

  **`src/stores/__tests__/auth.spec.ts`** (~5-8 tests):
  - Mock `@/api/auth` module with vi.mock
  - Create a Pinia test instance with `createTestingPinia` or `createPinia` + `setActivePinia`
  - Test initial state: user is null, isAuthenticated is false
  - Test login success: verify tokens stored, user fetched, isAuthenticated becomes true
  - Test login failure: verify error state set, isAuthenticated stays false
  - Test logout: verify state cleared, localStorage cleared
  - Test initialize: verify user restored from localStorage
  - Test isAdmin computed: true when user.role === 'admin', false otherwise
  - Test hasRole computed: returns correct boolean for role checks
  - Each test uses `beforeEach` to reset stores and mocks

  **`src/stores/__tests__/logStore.spec.ts`** (~3-5 tests):
  - Test addLogEntry: adds entry to logs array
  - Test addLogEntry with maxEntries: trims when exceeding max
  - Test clearLogs: empties logs array
  - Test trimLogs: reduces array to specified length

  **Part C: Write composable tests (TEST-04 partial)**

  **`src/composables/__tests__/useBackupFormatters.spec.ts`** (~3 tests):
  - Test formatting functions with various inputs
  - Pure functions, easy to test directly

  **`src/composables/__tests__/useNetworkSearch.spec.ts`** (~2-3 tests):
  - Mock wildcardMatcher utilities
  - Test search with wildcard patterns
  - Test search result filtering

  **Claude's discretion:** Additional composable tests for useD3Tooltip, useBackupApi, useSettingsApi, useNetworkUrlState. These are more complex and may not warrant the test investment given their tight coupling to Vue lifecycle and browser APIs.

  **Part D: Run vue-tsc full project verification (TSML-08)**

  After ALL migrations complete:
  ```bash
  cd frontend && npx vue-tsc --noEmit --project tsconfig.app.json
  ```
  This must exit 0 with zero errors. If any errors surface:
  - Fix type errors in the migrated files
  - Do NOT change Vue component files (.vue) — those are Phase 3+
  - Errors from .vue files are expected and acceptable (allowJs: true means they compile but aren't checked)
  - Only .ts file errors must be resolved

  Also run the full CI check:
  ```bash
  cd frontend && npm run lint && npm run build
  ```
  </action>
  <verify>
  Run `cd frontend && npx vue-tsc --noEmit --project tsconfig.app.json` — MUST exit 0 (TSML-08).
  Run `cd frontend && npx vitest run --reporter=verbose 2>&1 | tail -30` — all tests pass.
  Run `cd frontend && npm run build` — exits 0.
  Run `cd frontend && npm run lint` — exits 0.
  Verify no .js files remain in composables: `ls frontend/src/composables/*.js 2>/dev/null` should return nothing.
  Count total .js files remaining in src (should be only .vue files and no standalone .js):
  `find frontend/src -name "*.js" -not -path "*/node_modules/*" | head -20`
  </verify>
  <done>
  - All 6 composables migrated to .ts with typed return values
  - auth store tests: 5-8 tests covering state, actions, computed getters
  - logStore tests: 3-5 tests covering add, trim, clear
  - Composable tests: 5-6 tests for useBackupFormatters and useNetworkSearch
  - vue-tsc --noEmit exits 0 (TSML-08 verified)
  - npm run build, npm run lint both pass
  - Zero .js files remain outside .vue components
  - TEST-04 (composable tests) satisfied
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && npx vue-tsc --noEmit` exits 0 — TSML-08 verified (the primary success criterion)
2. `cd frontend && npx vitest run` — all tests pass (Button + API + store + composable tests)
3. `cd frontend && npm run build` exits 0
4. `cd frontend && npm run lint` exits 0
5. `find frontend/src -name "*.js" -not -path "*/node_modules/*" -not -name "*.vue" | wc -l` returns 0 — no standalone .js files remain
6. `cd frontend && npm run dev` — application loads, functions identically to before Phase 2
</verification>

<success_criteria>
- Both Pinia stores have typed state (ref<User | null>, ref<LogEntry[]>), getters, and actions
- All 6 composables have typed return values
- Router has RouteMeta augmentation (requiresAuth, requiresAdmin)
- main.ts boots with typed plugin registration
- vue-tsc --noEmit exits 0 across entire project (TSML-08)
- 13-16 tests pass (stores + composables) — TEST-04 satisfied
- All preceding tests still pass — no regressions
- Zero standalone .js files remain in src/ (only .vue files)
- Application functions identically with zero visual changes
</success_criteria>

<output>
After completion, create `.planning/phases/02-typescript-migration/02-03-SUMMARY.md`
</output>
